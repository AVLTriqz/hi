-- Karker Hub Ultra ‚Äî Final Boss Edition (single LocalScript)
-- Place in StarterPlayerScripts (LocalScript)
-- Features: fullscreen loading (snow + typewriter + progress + music),
-- centered animated hub (rainbow border), mobile+pc draggable, notifications,
-- ESP, float with slider, teleport-to-click & teleport to place/instance, server hop,
-- Special Sauce aura (fire + taser local visuals), minimize/toggle/destroy,
-- rickroll easter egg, cleanup on destroy/respawn.

-- SERVICES
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local Debris = game:GetService("Debris")
local SoundService = game:GetService("SoundService")

-- PLAYER
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- =================== CONFIG ===================
local CONF = {
    accentColor = Color3.fromRGB(255, 60, 60), -- red neon accent (changeable)
    hubBg = Color3.fromRGB(8,8,10),
    rainbowSpeed = 1.0, -- lower = faster
    defaultFlux = 0.55, -- default float strength
    auraRadius = 14, -- default Special Sauce radius
    -- Placeholder sounds (swap with your uploaded assets)
    SOUND = {
        bgLoop = "rbxassetid://1846133381",   -- background music loop
        click = "rbxassetid://2101148",
        hover = "rbxassetid://146069018",
        notif = "rbxassetid://138186576",
        rickroll = "rbxassetid://184614231"
    }
}
-- =================================================

-- ================ STATE ================
local STATE = {
    destroyed = false,
    gui = nil,
    parts = {},
    conns = {},
    esp = {enabled=false, boxes={}},
    float = {enabled=false, att=nil, vf=nil, strength = CONF.defaultFlux},
    special = {active=false, auraPart=nil, scanner=nil, radius = CONF.auraRadius},
    sounds = {},
    clickCount = 0,
    lastClickTick = 0
}

-- ================== UTIL HELPERS ==================
local function safeChar() return player.Character or player.CharacterAdded:Wait() end

local function tween(obj, time, props, style, dir)
    style = style or Enum.EasingStyle.Quad
    dir = dir or Enum.EasingDirection.Out
    local info = TweenInfo.new(time, style, dir)
    local t = TweenService:Create(obj, info, props)
    t:Play()
    return t
end

local function newUICorner(parent, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 12)
    c.Parent = parent
    return c
end

local function newStroke(parent, color, thickness)
    local s = Instance.new("UIStroke", parent)
    s.Color = color or Color3.fromRGB(30,30,30)
    s.Thickness = thickness or 1
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    return s
end

local function makeSound(id, vol, loop)
    if not id or id == "" then return nil end
    local s = Instance.new("Sound")
    s.SoundId = id
    s.Volume = vol or 1
    s.Looped = (loop == true)
    s.Parent = SoundService
    table.insert(STATE.sounds, s)
    return s
end

local function playSoundByPartialId(partial)
    for _, s in ipairs(STATE.sounds) do
        if s and tostring(s.SoundId):find(partial) then
            pcall(function() s:Play() end)
            return true
        end
    end
    return false
end

-- ================== SOUNDS PRELOAD ==================
-- create & play background loop
STATE.sounds.bg = makeSound(CONF.SOUND.bgLoop, 0.45, true)
pcall(function() if STATE.sounds.bg then STATE.sounds.bg:Play() end end)
makeSound(CONF.SOUND.click, 0.9, false)
makeSound(CONF.SOUND.hover, 0.7, false)
makeSound(CONF.SOUND.notif, 1, false)
makeSound(CONF.SOUND.rickroll, 0.8, false)

-- ================== NOTIFICATIONS (bottom-left) ==================
local function createNotifContainer()
    local sg = Instance.new("ScreenGui", playerGui)
    sg.Name = "KH_Notifs"
    sg.ResetOnSpawn = false

    local holder = Instance.new("Frame", sg)
    holder.Name = "Holder"
    holder.AnchorPoint = Vector2.new(0,1)
    holder.Position = UDim2.new(0, 12, 1, -12)
    holder.Size = UDim2.new(0, 360, 0, 420)
    holder.BackgroundTransparency = 1

    local layout = Instance.new("UIListLayout", holder)
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0,8)

    return sg, holder
end

local notifGui, notifHolder = createNotifContainer()
STATE.notifGui = notifGui

local function notify(title, text, duration)
    duration = duration or 3
    if STATE.destroyed then return end
    if not notifHolder or not notifHolder.Parent then
        notifGui, notifHolder = createNotifContainer()
    end

    local f = Instance.new("Frame", notifHolder)
    f.Size = UDim2.new(1,0,0,0)
    f.BackgroundColor3 = Color3.fromRGB(14, 14, 16)
    f.BorderSizePixel = 0
    newUICorner(f, 10)
    newStroke(f, CONF.accentColor, 1)

    local icon = Instance.new("TextLabel", f)
    icon.Size = UDim2.new(0,40,0,40)
    icon.Position = UDim2.new(0,8,0,8)
    icon.BackgroundTransparency = 1
    icon.Font = Enum.Font.GothamBlack
    icon.TextSize = 20
    icon.TextColor3 = CONF.accentColor
    icon.Text = "üîî"

    local t = Instance.new("TextLabel", f)
    t.Size = UDim2.new(1, -56, 0, 20)
    t.Position = UDim2.new(0,56,0,6)
    t.BackgroundTransparency = 1
    t.Font = Enum.Font.GothamBold
    t.TextSize = 14
    t.TextColor3 = CONF.accentColor
    t.Text = title
    t.TextXAlignment = Enum.TextXAlignment.Left

    local m = Instance.new("TextLabel", f)
    m.Size = UDim2.new(1, -56, 0, 44)
    m.Position = UDim2.new(0,56,0,26)
    m.BackgroundTransparency = 1
    m.Font = Enum.Font.Gotham
    m.TextSize = 13
    m.TextColor3 = Color3.fromRGB(220,220,220)
    m.Text = text
    m.TextWrapped = true
    m.TextXAlignment = Enum.TextXAlignment.Left

    -- slide open
    tween(f, 0.28, {Size = UDim2.new(1,0,0,92)})
    pcall(function() playSoundByPartialId("138186576") end) -- notif sfx

    task.delay(duration, function()
        if f and f.Parent then
            tween(f, 0.18, {Size = UDim2.new(1,0,0,0)})
            task.wait(0.22)
            if f and f.Parent then f:Destroy() end
        end
    end)
end

-- ================== LOADING SCREEN ==================
local function spawnLoading(onFinished)
    local gui = Instance.new("ScreenGui", playerGui)
    gui.Name = "KH_Loading"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true

    local bg = Instance.new("Frame", gui)
    bg.Size = UDim2.new(1,0,1,0)
    bg.Position = UDim2.new(0,0,0,0)
    bg.BackgroundColor3 = CONF.hubBg
    bg.BorderSizePixel = 0

    local vign = Instance.new("ImageLabel", bg)
    vign.Size = UDim2.new(1.6,0,1.6,0)
    vign.Position = UDim2.new(-0.3,0,-0.3,0)
    vign.BackgroundTransparency = 1
    vign.Image = "rbxassetid://5058094581"
    vign.ImageTransparency = 0.62

    local title = Instance.new("TextLabel", bg)
    title.Size = UDim2.new(0.9,0,0,72)
    title.Position = UDim2.new(0.05,0,0.14,0)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBlack
    title.TextSize = 28
    title.TextColor3 = Color3.fromRGB(255,255,255)
    title.Text = "Karker Hub Ultra ‚Äî Final Boss"

    local center = Instance.new("TextLabel", bg)
    center.Size = UDim2.new(0.86,0,0,120)
    center.Position = UDim2.new(0.07,0,0.42,0)
    center.BackgroundTransparency = 1
    center.Font = Enum.Font.Gotham
    center.TextSize = 16
    center.TextColor3 = Color3.fromRGB(220,220,220)
    center.TextWrapped = true
    center.TextXAlignment = Enum.TextXAlignment.Center
    center.Text = ""

    local barBg = Instance.new("Frame", bg)
    barBg.Size = UDim2.new(0.56,0,0,14)
    barBg.Position = UDim2.new(0.22,0,0.72,0)
    barBg.BackgroundColor3 = Color3.fromRGB(18,18,20)
    newUICorner(barBg, 8)
    newStroke(barBg, Color3.fromRGB(40,40,44), 1)

    local barFill = Instance.new("Frame", barBg)
    barFill.Size = UDim2.new(0,0,1,0)
    barFill.BackgroundColor3 = CONF.accentColor
    newUICorner(barFill, 8)

    -- snow frames container
    local snowFolder = Instance.new("Folder", bg)

    -- small snow generator
    spawn(function()
        while bg.Parent do
            local fl = Instance.new("Frame", snowFolder)
            fl.Size = UDim2.new(0, math.random(3,7), 0, math.random(3,7))
            fl.Position = UDim2.new(math.random(), 0, -0.1, 0)
            fl.BackgroundColor3 = Color3.fromRGB(255,255,255)
            fl.BackgroundTransparency = 0.22
            fl.BorderSizePixel = 0
            local xoff = math.random(-160,160)
            TweenService:Create(fl, TweenInfo.new(math.random(4,8)), {
                Position = UDim2.new(fl.Position.X.Scale, xoff, 1.12, 0),
                BackgroundTransparency = 1
            }):Play()
            Debris:AddItem(fl, 6)
            task.wait(0.07)
        end
    end)

    -- jokes for typewriter
    local jokes = {
        "‚ú® booting drip & red neon...",
        "üçï bribing servers with pizza ‚Äî hold pls...",
        "ü§ñ installing 'steal politely' module...",
        "üíÄ locating stray pets... very sus",
        "üéâ applying snow, glitter & chaos"
    }
    local msg = jokes[math.random(1,#jokes)]
    playSoundByPartialId("2101148") -- click sfx

    -- typewriter
    spawn(function()
        for i = 1, #msg do
            center.Text = msg:sub(1,i)
            task.wait(0.03)
        end
    end)

    -- animated progress
    spawn(function()
        local prog = 0
        local steps = {0.12, 0.28, 0.48, 0.72, 0.9, 1}
        for _, t in ipairs(steps) do
            while prog < t do
                prog = math.min(t, prog + (0.01 + math.random() * 0.03))
                TweenService:Create(barFill, TweenInfo.new(0.12), {Size = UDim2.new(prog, 0, 1, 0)}):Play()
                task.wait(0.06)
            end
            task.wait(0.16 + math.random() * 0.5)
        end
        task.wait(0.7)
        TweenService:Create(bg, TweenInfo.new(0.8), {BackgroundTransparency = 1}):Play()
        TweenService:Create(title, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
        TweenService:Create(center, TweenInfo.new(0.8), {TextTransparency = 1}):Play()
        TweenService:Create(barBg, TweenInfo.new(0.6), {BackgroundTransparency = 1}):Play()
        task.wait(0.9)
        if snowFolder and snowFolder.Parent then snowFolder:Destroy() end
        gui:Destroy()
        if type(onFinished) == "function" then pcall(onFinished) end
    end)
end

-- ================== HUB UI BUILD ==================
local function buildHub()
    if STATE.destroyed then return end
    local gui = Instance.new("ScreenGui", playerGui)
    gui.Name = "KarkerHubUltra"
    gui.ResetOnSpawn = false
    STATE.gui = gui

    -- main window (start tiny for scale-in)
    local window = Instance.new("Frame", gui)
    window.Name = "Window"
    window.Size = UDim2.new(0, 24, 0, 24)
    window.Position = UDim2.new(0.5, 0, 0.5, 0)
    window.AnchorPoint = Vector2.new(0.5, 0.5)
    window.BackgroundColor3 = CONF.hubBg
    window.BorderSizePixel = 0
    newUICorner(window, 20)
    newStroke(window, Color3.fromRGB(28,28,30), 1)

    -- animated rainbow border (UIStroke)
    local border = Instance.new("UIStroke", window)
    border.Thickness = 3
    border.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    border.Color = Color3.fromHSV(0,1,1)
    -- animate hue
    local hue = 0
    if STATE.conns.rainbow and type(STATE.conns.rainbow.Disconnect) == "function" then
        pcall(function() STATE.conns.rainbow:Disconnect() end)
    end
    STATE.conns.rainbow = RunService.RenderStepped:Connect(function(dt)
        hue = (hue + dt * (1 / CONF.rainbowSpeed)) % 1
        border.Color = Color3.fromHSV(hue, 0.95, 1)
    end)

    -- soft snow frames inside window (visual)
    local bgSnow = Instance.new("Folder", window)
    bgSnow.Name = "BG_Snow"
    spawn(function()
        while window and window.Parent do
            local s = Instance.new("Frame", bgSnow)
            s.Size = UDim2.new(0, math.random(2,6), 0, math.random(2,6))
            s.Position = UDim2.new(math.random(), 0, -0.12, 0)
            s.BackgroundColor3 = Color3.fromRGB(255,255,255)
            s.BackgroundTransparency = 0.84
            s.BorderSizePixel = 0
            local x = math.random(-120,120)
            TweenService:Create(s, TweenInfo.new(math.random(6,10)), {Position = UDim2.new(s.Position.X.Scale, x, 1.12, 0)}):Play()
            Debris:AddItem(s, 10)
            task.wait(0.14)
        end
    end)

    -- Header
    local header = Instance.new("Frame", window)
    header.Size = UDim2.new(1,0,0,84)
    header.Position = UDim2.new(0,0,0,0)
    header.BackgroundColor3 = Color3.fromRGB(18,18,20)
    newUICorner(header, 14)

    local title = Instance.new("TextLabel", header)
    title.Size = UDim2.new(0.7,0,1,0)
    title.Position = UDim2.new(0.04,0,0,0)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBlack
    title.TextSize = 22
    title.TextColor3 = Color3.fromRGB(250,250,250)
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Text = "Karker Hub Ultra üî•"

    local subtitle = Instance.new("TextLabel", header)
    subtitle.Size = UDim2.new(0.66,0,0,18)
    subtitle.Position = UDim2.new(0.04,0,1,-24)
    subtitle.BackgroundTransparency = 1
    subtitle.Font = Enum.Font.Gotham
    subtitle.TextSize = 12
    subtitle.TextColor3 = Color3.fromRGB(200,200,200)
    subtitle.Text = "Created by YOUNG ‚Äî Final Boss"

    -- rotating subtitle lines
    spawn(function()
        local lines = {"certified stealer", "brainrot üòé", "red neon go brrr", "snow + neon = vibe", "not banned (probably)"}
        while header and header.Parent do
            subtitle.Text = lines[math.random(1,#lines)]
            task.wait(3 + math.random()*3)
        end
    end)

    -- title easter egg (5 quick clicks -> rickroll)
    title.InputBegan:Connect(function(input)
        if input.UserInputType ~= Enum.UserInputType.MouseButton1 and input.UserInputType ~= Enum.UserInputType.Touch then return end
        local t = tick()
        if t - STATE.lastClickTick > 2 then STATE.clickCount = 0 end
        STATE.clickCount = STATE.clickCount + 1
        STATE.lastClickTick = t
        playSoundByPartialId("146069018") -- hover
        if STATE.clickCount >= 5 then
            notify("Easter Egg", "Rickroll engaged. Enjoy! üòÇ", 4)
            playSoundByPartialId("184614231")
            STATE.clickCount = 0
        end
    end)

    -- header control buttons (min/toggle/destroy)
    local function makeHeaderBtn(parent, text, posOffset, bgc)
        local b = Instance.new("TextButton", parent)
        b.Size = UDim2.new(0,36,0,32)
        b.Position = posOffset
        b.Font = Enum.Font.GothamBold
        b.TextSize = 18
        b.Text = text
        b.BackgroundColor3 = bgc or Color3.fromRGB(28,28,30)
        newUICorner(b, 8)
        return b
    end
    local btnMin = makeHeaderBtn(header, "‚Äî", UDim2.new(1, -192, 0.12, 0))
    local btnToggle = makeHeaderBtn(header, "‚ü≥", UDim2.new(1, -132, 0.12, 0))
    local btnDestroy = makeHeaderBtn(header, "X", UDim2.new(1, -72, 0.12, 0), Color3.fromRGB(140,36,36))

    -- Draggable header (works on PC + mobile)
    do
        local dragging, dragInput, dragStart, startPos = false, nil, nil, nil
        header.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                dragStart = input.Position
                startPos = window.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end)
        header.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
                dragInput = input
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if input == dragInput and dragging then
                local delta = input.Position - dragStart
                local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
                -- clamp within viewport bounds
                local view = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
                local winSize = window.AbsoluteSize
                local left = math.clamp(newPos.X.Offset, -winSize.X*0.8, view.X - 60)
                local top = math.clamp(newPos.Y.Offset, -winSize.Y*0.8, view.Y - 60)
                window.Position = UDim2.new(0, left, 0, top)
            end
        end)
    end

    -- content
    local content = Instance.new("Frame", window)
    content.Size = UDim2.new(1, -36, 1, -122)
    content.Position = UDim2.new(0, 18, 0, 92)
    content.BackgroundTransparency = 1

    local leftPanel = Instance.new("Frame", content)
    leftPanel.Size = UDim2.new(0, 320, 1, 0)
    leftPanel.Position = UDim2.new(0,0,0,0)
    leftPanel.BackgroundTransparency = 1

    local rightPanel = Instance.new("Frame", content)
    rightPanel.Size = UDim2.new(1, -340, 1, 0)
    rightPanel.Position = UDim2.new(0, 340, 0, 0)
    rightPanel.BackgroundTransparency = 1

    -- left scroll for buttons
    local leftScroll = Instance.new("ScrollingFrame", leftPanel)
    leftScroll.Size = UDim2.new(1,0,1,0)
    leftScroll.CanvasSize = UDim2.new(0,0,0,1600)
    leftScroll.ScrollBarThickness = 8
    leftScroll.BackgroundTransparency = 1
    local leftLayout = Instance.new("UIListLayout", leftScroll)
    leftLayout.Padding = UDim.new(0, 10)
    leftLayout.SortOrder = Enum.SortOrder.LayoutOrder

    -- right info box
    local infoTitle = Instance.new("TextLabel", rightPanel)
    infoTitle.Size = UDim2.new(1, -8, 0, 24)
    infoTitle.Position = UDim2.new(0,4,0,0)
    infoTitle.BackgroundTransparency = 1
    infoTitle.Font = Enum.Font.GothamBold
    infoTitle.TextSize = 14
    infoTitle.TextColor3 = Color3.fromRGB(240,240,240)
    infoTitle.Text = "Status / Info"

    local infoBox = Instance.new("TextLabel", rightPanel)
    infoBox.Size = UDim2.new(1, -8, 1, -36)
    infoBox.Position = UDim2.new(0,4,0,32)
    infoBox.BackgroundColor3 = Color3.fromRGB(8,8,10)
    newUICorner(infoBox, 10)
    newStroke(infoBox, Color3.fromRGB(20,20,22), 1)
    infoBox.Font = Enum.Font.Gotham
    infoBox.TextSize = 13
    infoBox.TextColor3 = Color3.fromRGB(200,200,200)
    infoBox.TextWrapped = true
    infoBox.Text = ("Welcome, %s ‚Äî Created by YOUNG"):format(player.Name)

    -- Button factory
    local function makeButton(text, emoji)
        local btn = Instance.new("TextButton", leftScroll)
        btn.Size = UDim2.new(1, -16, 0, 60)
        btn.Position = UDim2.new(0,8,0,0)
        btn.BackgroundColor3 = Color3.fromRGB(12,12,14)
        newUICorner(btn, 12)
        newStroke(btn, Color3.fromRGB(24,24,26), 1)
        btn.Font = Enum.Font.GothamSemibold
        btn.Text = ((emoji and (emoji.."  ") or "") .. text)
        btn.TextSize = 16
        btn.TextColor3 = Color3.fromRGB(230,230,230)
        btn.AutoButtonColor = false

        btn.MouseEnter:Connect(function()
            playSoundByPartialId("146069018")
            tween(btn, 0.12, {BackgroundColor3 = Color3.fromRGB(28,6,6), Size = UDim2.new(1, -12, 0, 64)})
            -- tiny spark effect: small frame fade
            local fx = Instance.new("Frame", btn)
            fx.Size = UDim2.new(0, 6, 0, 6)
            fx.Position = UDim2.new(0.9, -6, 0.5, -3)
            fx.BackgroundColor3 = Color3.fromRGB(255,160,60)
            newUICorner(fx, 3)
            fx.BackgroundTransparency = 0
            tween(fx, 0.4, {BackgroundTransparency = 1, Size = UDim2.new(0, 28, 0, 28)})
            Debris:AddItem(fx, 0.45)
        end)
        btn.MouseLeave:Connect(function()
            tween(btn, 0.12, {BackgroundColor3 = Color3.fromRGB(12,12,14), Size = UDim2.new(1, -16, 0, 60)})
        end)
        btn.MouseButton1Click:Connect(function()
            playSoundByPartialId("2101148")
            tween(btn, 0.08, {Size = UDim2.new(1, -18, 0, 56)})
            task.delay(0.12, function()
                if btn and btn.Parent then tween(btn, 0.12, {Size = UDim2.new(1, -16, 0, 60)}) end
            end)
        end)
        return btn
    end

    -- FLOAT slider UI on right panel
    local floatLabel = Instance.new("TextLabel", rightPanel)
    floatLabel.Size = UDim2.new(1, -8, 0, 20)
    floatLabel.Position = UDim2.new(0,4,1,-160)
    floatLabel.BackgroundTransparency = 1
    floatLabel.Font = Enum.Font.GothamSemibold
    floatLabel.TextSize = 12
    floatLabel.TextColor3 = Color3.fromRGB(200,200,200)
    floatLabel.Text = "Float Strength"

    local track = Instance.new("Frame", rightPanel)
    track.Size = UDim2.new(0.9, 0, 0, 18)
    track.Position = UDim2.new(0,8,1,-132)
    track.BackgroundColor3 = Color3.fromRGB(22,22,24)
    newUICorner(track, 9)
    newStroke(track, Color3.fromRGB(26,26,28), 1)

    local knob = Instance.new("Frame", track)
    knob.Size = UDim2.new(STATE.float.strength, 0, 1, 0)
    knob.BackgroundColor3 = CONF.accentColor
    newUICorner(knob, 9)

    local knobValue = Instance.new("TextLabel", rightPanel)
    knobValue.Size = UDim2.new(0.18,0,0,18)
    knobValue.Position = UDim2.new(0.82,0,1,-132)
    knobValue.BackgroundTransparency = 1
    knobValue.Font = Enum.Font.Gotham
    knobValue.TextSize = 12
    knobValue.TextColor3 = Color3.fromRGB(220,220,220)
    knobValue.Text = string.format("%.0f%%", STATE.float.strength * 100)

    do
        local draggingKnob = false
        local function updateKnob(input)
            if not draggingKnob then return end
            local pos = input.Position
            local trackPos = track.AbsolutePosition
            local trackSize = track.AbsoluteSize
            local x = math.clamp(pos.X - trackPos.X, 0, trackSize.X)
            local t = x / trackSize.X
            knob.Size = UDim2.new(t, 0, 1, 0)
            STATE.float.strength = math.clamp(t, 0.05, 0.95)
            knobValue.Text = string.format("%.0f%%", STATE.float.strength * 100)
            -- update VectorForce if active
            if STATE.float.enabled and STATE.float.vf and STATE.float.att then
                local char = player.Character
                if char and char:FindFirstChild("HumanoidRootPart") then
                    local mass = char.HumanoidRootPart:GetMass()
                    STATE.float.vf.Force = Vector3.new(0, mass * workspace.Gravity * STATE.float.strength, 0)
                end
            end
        end

        knob.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                draggingKnob = true
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then draggingKnob = false end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if draggingKnob and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                pcall(updateKnob, input)
            end
        end)
    end

    -- HELPERS: create ring part for aura
    local function createAuraRing(radius, color)
        local p = Instance.new("Part", workspace)
        p.Anchored = true
        p.CanCollide = false
        p.Size = Vector3.new(radius*2, 0.25, radius*2)
        p.Material = Enum.Material.Neon
        p.Color = color or CONF.accentColor
        p.Transparency = 0.32
        p.Shape = Enum.PartType.Cylinder
        p.Orientation = Vector3.new(90,0,0)
        p.Name = "KH_AuraRing"
        return p
    end

    -- ESP FUNCTIONS (local visuals)
    local function createESPFor(pl)
        if not pl.Character then return end
        local head = pl.Character:FindFirstChild("Head")
        if not head then return end
        if head:FindFirstChild("KH_ESP_Billboard") then return end
        local b = Instance.new("BillboardGui", head)
        b.Name = "KH_ESP_Billboard"
        b.Adornee = head
        b.AlwaysOnTop = true
        b.Size = UDim2.new(0, 160, 0, 36)
        local txt = Instance.new("TextLabel", b)
        txt.Size = UDim2.new(1,0,1,0)
        txt.BackgroundTransparency = 1
        txt.Font = Enum.Font.GothamBold
        txt.TextSize = 14
        txt.TextColor3 = CONF.accentColor
        txt.Text = pl.Name

        -- small neon box (part)
        if not pl.Character:FindFirstChild("KH_ESP_Box") then
            local box = Instance.new("Part", workspace)
            box.Name = "KH_ESP_Box"
            box.Transparency = 0.75
            box.Anchored = true
            box.CanCollide = false
            box.Size = Vector3.new(2,3,0.2)
            box.Material = Enum.Material.Neon
            box.Color = CONF.accentColor
            STATE.esp.boxes[pl] = box
            table.insert(STATE.parts, box)
        end
    end

    local function removeESPFor(pl)
        if pl.Character and pl.Character:FindFirstChild("Head") then
            local b = pl.Character.Head:FindFirstChild("KH_ESP_Billboard")
            if b then b:Destroy() end
        end
        if STATE.esp.boxes[pl] then
            pcall(function() STATE.esp.boxes[pl]:Destroy() end)
            STATE.esp.boxes[pl] = nil
        end
    end

    local function updateESP()
        for pl, box in pairs(STATE.esp.boxes) do
            if pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = pl.Character.HumanoidRootPart
                box.CFrame = CFrame.new(hrp.Position + Vector3.new(0,1.6,0))
                box.Size = Vector3.new(2.2, 3.6, 0.2)
            else
                pcall(function() box:Destroy() end)
                STATE.esp.boxes[pl] = nil
            end
        end
    end

    local function toggleESP()
        STATE.esp.enabled = not STATE.esp.enabled
        if STATE.esp.enabled then
            notify("ESP", "Enabled (local visuals) üëÄ", 3)
            for _, pl in ipairs(Players:GetPlayers()) do if pl ~= player then createESPFor(pl) end end
            if not STATE.conns.espUpdater then
                STATE.conns.espUpdater = RunService.RenderStepped:Connect(updateESP)
            end
        else
            notify("ESP", "Disabled", 2)
            for _, pl in ipairs(Players:GetPlayers()) do removeESPFor(pl) end
            if STATE.conns.espUpdater then pcall(function() STATE.conns.espUpdater:Disconnect() end) end
            STATE.conns.espUpdater = nil
        end
    end

    -- SPECIAL SAUCE aura (local visuals + local stun)
    local function toggleSpecialSauce()
        if STATE.special.active then
            STATE.special.active = false
            if STATE.special.scanner then pcall(function() STATE.special.scanner:Disconnect() end) end
            if STATE.special.auraPart and STATE.special.auraPart.Parent then STATE.special.auraPart:Destroy() end
            notify("Special Sauce", "Deactivated. Aura removed üëã", 2)
            infoBox.Text = "Special Sauce: stopped."
            return
        end
        local char = safeChar()
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then notify("Special Sauce", "Character not ready.", 2); return end

        notify("Special Sauce", "huh I see u tryna steal lol üòà", 3)
        task.wait(2)

        local ring = createAuraRing(STATE.special.radius, CONF.accentColor)
        ring.Parent = workspace
        STATE.special.auraPart = ring
        table.insert(STATE.parts, ring)

        -- fire particle
        local flame = Instance.new("ParticleEmitter", hrp)
        flame.Texture = "rbxassetid://241594408"
        flame.Rate = 70
        flame.Lifetime = NumberRange.new(0.9,1.6)
        flame.Size = NumberSequence.new(1.1)
        flame.Speed = NumberRange.new(0.2,0.7)
        Debris:AddItem(flame, 12)

        STATE.special.active = true
        infoBox.Text = "Special Sauce: active. Radius: " .. tostring(STATE.special.radius) .. " studs."

        STATE.special.scanner = RunService.Heartbeat:Connect(function()
            if not STATE.special.active then return end
            if not (ring and ring.Parent and hrp and hrp.Parent) then return end
            ring.Position = hrp.Position - Vector3.new(0, 3, 0)
            for _, pl in ipairs(Players:GetPlayers()) do
                if pl ~= player and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
                    local otherHRP = pl.Character.HumanoidRootPart
                    local dist = (otherHRP.Position - hrp.Position).Magnitude
                    if dist <= STATE.special.radius then
                        -- simple bolt visual
                        local mag = dist
                        local bolt = Instance.new("Part", workspace)
                        bolt.Anchored = true
                        bolt.CanCollide = false
                        bolt.Size = Vector3.new(0.25,0.25,mag)
                        bolt.CFrame = CFrame.new(hrp.Position, otherHRP.Position) * CFrame.new(0,0,-mag/2) * CFrame.Angles(math.pi/2,0,0)
                        bolt.Material = Enum.Material.Neon
                        bolt.Color = Color3.fromRGB(140,220,255)
                        Debris:AddItem(bolt, 0.26)

                        local spark = Instance.new("ParticleEmitter", otherHRP)
                        spark.Texture = "rbxassetid://256249139"
                        spark.Rate = 0
                        spark:Emit(30)
                        Debris:AddItem(spark, 0.6)

                        notify("TASER", pl.Name .. " triggered the aura (local) ‚ö°", 2)

                        local hum = pl.Character:FindFirstChildOfClass("Humanoid")
                        if hum then
                            local prevWS = hum.WalkSpeed
                            local prevJP = hum.JumpPower or 50
                            pcall(function() hum.WalkSpeed = 0 hum.JumpPower = 0 end)
                            task.delay(2.6, function()
                                pcall(function() hum.WalkSpeed = prevWS or 16 hum.JumpPower = prevJP end)
                            end)
                        end
                    end
                end
            end
        end)
    end

    -- FLOAT toggle (VectorForce local)
    local function toggleFloat()
        if not STATE.float.enabled then
            local char = player.Character or player.CharacterAdded:Wait()
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hrp then notify("Float", "Character root missing.", 2); return end
            if STATE.float.att then pcall(function() STATE.float.att:Destroy() end) end
            if STATE.float.vf then pcall(function() STATE.float.vf:Destroy() end) end
            local att = Instance.new("Attachment", hrp)
            att.Name = "KH_FloatAttach"
            local vf = Instance.new("VectorForce", hrp)
            vf.Attachment0 = att
            vf.RelativeTo = Enum.ActuatorRelativeTo.World
            local mass = hrp:GetMass()
            vf.Force = Vector3.new(0, mass * workspace.Gravity * STATE.float.strength, 0)
            STATE.float.att = att
            STATE.float.vf = vf
            STATE.float.enabled = true
            notify("Float", "Float enabled ‚Äî glide mode üïäÔ∏è", 3)
            infoBox.Text = "Float enabled (strength " .. string.format("%.0f%%", STATE.float.strength*100) .. ")"
        else
            if STATE.float.vf then pcall(function() STATE.float.vf:Destroy() end) end
            if STATE.float.att then pcall(function() STATE.float.att:Destroy() end) end
            STATE.float.att = nil
            STATE.float.vf = nil
            STATE.float.enabled = false
            notify("Float", "Float disabled", 2)
            infoBox.Text = "Float disabled"
        end
    end

    -- TELEPORT ANYWHERE via click/touch
    local teleportConn = nil
    local function startTeleportClick()
        notify("Teleport", "Tap/click anywhere to teleport there üöÄ", 3)
        if teleportConn then pcall(function() teleportConn:Disconnect() end) end
        teleportConn = UserInputService.InputBegan:Connect(function(input, processed)
            if processed then return end
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                local m = player:GetMouse()
                if m and m.Hit and m.Target then
                    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        hrp.CFrame = CFrame.new(m.Hit.Position + Vector3.new(0,3,0))
                        notify("Teleport", "Teleported to target ‚ú®", 2)
                    end
                end
                if teleportConn then teleportConn:Disconnect(); teleportConn = nil end
            end
        end)
    end

    -- SERVER HOP (basic attempt)
    local function doServerHop()
        notify("Server Hop", "Attempting server hop... (may fail)", 3)
        pcall(function() TeleportService:Teleport(game.PlaceId, player) end)
    end

    -- TELEPORT to place / instance
    local function teleportToPlace(pidText)
        local pid = tonumber(pidText)
        if not pid then notify("Teleport", "Invalid place id.", 3); return end
        notify("Teleport", "Teleporting to place " .. tostring(pid) .. "...", 3)
        pcall(function() TeleportService:Teleport(pid, player) end)
    end
    local function teleportToInstance(pidText, instText)
        local pid = tonumber(pidText)
        local inst = tostring(instText)
        if not pid or inst == "" then notify("Teleport", "Place ID and Instance ID required.", 3); return end
        notify("Teleport", "Teleporting to instance...", 3)
        pcall(function() TeleportService:TeleportToPlaceInstance(pid, inst, player) end)
    end

    -- CLEANUP function local to hub (destroys gui + parts + disconnects)
    local function cleanup()
        STATE.destroyed = true
        -- disconnect any module connections
        for k,c in pairs(STATE.conns) do
            if c and type(c.Disconnect) == "function" then
                pcall(function() c:Disconnect() end)
            end
        end
        STATE.conns = {}
        if STATE.special.scanner then pcall(function() STATE.special.scanner:Disconnect() end) end
        if teleportConn then pcall(function() teleportConn:Disconnect() end) end
        if STATE.conns.espUpdater then pcall(function() STATE.conns.espUpdater:Disconnect() end) end
        -- destroy spawned parts
        for _, p in ipairs(STATE.parts) do
            pcall(function() if p and p.Parent then p:Destroy() end end)
        end
        STATE.parts = {}
        -- remove esp boxes
        for pl, box in pairs(STATE.esp.boxes) do
            pcall(function() if box and box.Parent then box:Destroy() end end)
        end
        STATE.esp.boxes = {}
        -- destroy gui
        pcall(function() if gui and gui.Parent then gui:Destroy() end end)
        if notifGui and notifGui.Parent then notifGui:Destroy() end
        -- stop sounds
        for _, s in ipairs(STATE.sounds) do
            pcall(function() if s and s.IsPlaying then s:Stop() end end)
            pcall(function() if s and s.Parent then s:Destroy() end end)
        end
        STATE.sounds = {}
    end

    -- WIRE UI Buttons (make them and attach module actions)
    local bSpecial = makeButton("Special Sauce (toggle)", "üõ°Ô∏è")
    bSpecial.MouseButton1Click:Connect(function() toggleSpecialSauce() end)

    local bFloat = makeButton("Toggle Float", "üïäÔ∏è")
    bFloat.MouseButton1Click:Connect(function() toggleFloat() end)

    local bTaser = makeButton("Taser Aura (scan)", "‚ö°")
    do
        local active = false; local conn = nil
        bTaser.MouseButton1Click:Connect(function()
            active = not active
            if active then
                notify("Taser Aura", "Started scanning (local visuals) ‚ö°", 3)
                conn = RunService.Heartbeat:Connect(function()
                    local char = player.Character
                    if not (char and char:FindFirstChild("HumanoidRootPart")) then return end
                    local hrp = char.HumanoidRootPart
                    for _, pl in ipairs(Players:GetPlayers()) do
                        if pl ~= player and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
                            local otherHRP = pl.Character.HumanoidRootPart
                            local d = (otherHRP.Position - hrp.Position).Magnitude
                            if d <= 12 then
                                -- local bolt visual
                                local bolt = Instance.new("Part", workspace)
                                bolt.Anchored = true; bolt.CanCollide = false; bolt.Material = Enum.Material.Neon
                                bolt.Color = Color3.fromRGB(255,210,100); bolt.Size = Vector3.new(0.2,0.2,d)
                                bolt.CFrame = CFrame.new(hrp.Position, otherHRP.Position) * CFrame.new(0,0,-d/2) * CFrame.Angles(math.pi/2,0,0)
                                Debris:AddItem(bolt, 0.26)
                                local spark = Instance.new("ParticleEmitter", otherHRP); spark.Texture="rbxassetid://256249139"; spark.Rate=0; spark:Emit(24); Debris:AddItem(spark,0.5)
                                notify("TASER", pl.Name .. " zapped (local) üòµ", 2)
                            end
                        end
                    end
                end)
                STATE.conns.taserConn = conn
            else
                if conn then pcall(function() conn:Disconnect() end) end
                notify("Taser Aura", "Stopped", 2)
                STATE.conns.taserConn = nil
            end
        end)
    end

    local bESP = makeButton("ESP Toggle", "üì°")
    bESP.MouseButton1Click:Connect(function() toggleESP() end)

    local bTPClick = makeButton("Teleport Anywhere (click)", "üìç")
    bTPClick.MouseButton1Click:Connect(function() startTeleportClick() end)

    local bServerHop = makeButton("Server Hop", "üîÄ")
    bServerHop.MouseButton1Click:Connect(function() doServerHop() end)

    -- Teleport input fields (right side)
    local pidBox = Instance.new("TextBox", rightPanel)
    pidBox.Size = UDim2.new(1, -8, 0, 28)
    pidBox.Position = UDim2.new(0,4,1,-228)
    pidBox.PlaceholderText = "Place ID (number)"
    pidBox.Text = ""
    pidBox.Font = Enum.Font.Gotham
    pidBox.BackgroundColor3 = Color3.fromRGB(10,10,12)
    newUICorner(pidBox, 8)

    local instBox = Instance.new("TextBox", rightPanel)
    instBox.Size = UDim2.new(1, -8, 0, 28)
    instBox.Position = UDim2.new(0,4,1,-188)
    instBox.PlaceholderText = "Instance ID (JobId) (optional)"
    instBox.Text = ""
    instBox.Font = Enum.Font.Gotham
    instBox.BackgroundColor3 = Color3.fromRGB(10,10,12)
    newUICorner(instBox, 8)

    local bTPToPlace = makeButton("Teleport to Place", "üõ∞Ô∏è")
    bTPToPlace.MouseButton1Click:Connect(function() teleportToPlace(pidBox.Text) end)

    local bTPToInstance = makeButton("Teleport to Instance", "üîó")
    bTPToInstance.MouseButton1Click:Connect(function() teleportToInstance(pidBox.Text, instBox.Text) end)

    local bPrivate = makeButton("Private Server (instructions)", "üîí")
    bPrivate.MouseButton1Click:Connect(function()
        notify("Private TP", "Paste PlaceId and JobId into the right boxes and click Teleport to Instance. Can't auto-join private servers without JobId.", 6)
    end)

    -- Header button wiring
    local isMin = false
    btnMin.MouseButton1Click:Connect(function()
        isMin = not isMin
        if isMin then
            tween(window, 0.28, {Size = UDim2.new(0, 560, 0, 110)})
        else
            tween(window, 0.28, {Size = UDim2.new(0, 560, 0, 620)})
        end
    end)
    btnToggle.MouseButton1Click:Connect(function()
        window.Visible = not window.Visible
    end)
    btnDestroy.MouseButton1Click:Connect(function()
        notify("Karker Hub", "Destroying hub and cleaning up...", 2)
        cleanup()
    end)

    -- Player add/remove events for ESP
    STATE.conns.playerAdded = Players.PlayerAdded:Connect(function(pl)
        if STATE.esp.enabled then createESPFor(pl) end
    end)
    STATE.conns.playerRemoving = Players.PlayerRemoving:Connect(function(pl)
        removeESPFor(pl)
    end)

    -- ensure esp updater runs
    if not STATE.conns.espUpdater then
        STATE.conns.espUpdater = RunService.RenderStepped:Connect(function()
            if STATE.esp.enabled then updateESP() end
        end)
    end

    -- scale-in + center + bounce
    tween(window, 0.65, {Size = UDim2.new(0, 560, 0, 620), Position = UDim2.new(0.5, 0, 0.5, 0)}, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

    -- store gui
    STATE.gui = gui
    table.insert(STATE.parts, gui)
end

-- ================= STARTUP =================
spawnLoading(function()
    if STATE.destroyed then return end
    buildHub()
    notify("Welcome", ("Welcome %s ‚Äî Karker Hub Ultra loaded. Created by YOUNG üéâ"):format(player.Name), 4)
end)

-- ================= RESPWAN HANDLING =================
Players.LocalPlayer.CharacterAdded:Connect(function(char)
    task.delay(0.5, function()
        -- reapply float if enabled
        if STATE.float.enabled then
            if STATE.float.att then pcall(function() STATE.float.att:Destroy() end) end
            if STATE.float.vf then pcall(function() STATE.float.vf:Destroy() end) end
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                local att = Instance.new("Attachment", hrp); STATE.float.att = att
                local vf = Instance.new("VectorForce", hrp); vf.Attachment0 = att; vf.RelativeTo = Enum.ActuatorRelativeTo.World
                local mass = hrp:GetMass(); vf.Force = Vector3.new(0, mass * workspace.Gravity * STATE.float.strength, 0); STATE.float.vf = vf
            end
        end
        -- refresh ESP for self if enabled
        if STATE.esp.enabled then
            -- nothing special for local player billboard; other players handled by playerAdded
        end
    end)
end)

-- Expose cleanup to global for ease
_G.KarkerHubCleanup = function() 
    -- attempt to cleanup gracefully
    notify("Karker Hub", "Global cleanup invoked.", 2)
    -- destroy local stuff
    pcall(function()
        for _, s in ipairs(STATE.sounds) do pcall(function() if s and s.IsPlaying then s:Stop() end end) end
    end)
    -- destroy GUI & parts
    pcall(function() if STATE.gui and STATE.gui.Parent then STATE.gui:Destroy() end end)
    pcall(function() if notifGui and notifGui.Parent then notifGui:Destroy() end end)
    STATE.destroyed = true
end

-- Done.
